<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Qu·∫£n l√Ω Gi·∫•c ng·ªß</title>
    
    <!-- Safari/iOS optimizations -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Qu·∫£n l√Ω Gi·∫•c ng·ªß">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#667eea">
    
    <!-- PWA icons for Safari -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23667eea' rx='20'/><text x='90' y='115' text-anchor='middle' font-size='80' fill='white'>üåô</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23667eea' rx='4'/><text x='16' y='24' text-anchor='middle' font-size='16' fill='white'>üåô</text></svg>">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <h1><i class="fas fa-moon"></i> Qu·∫£n l√Ω Gi·∫•c ng·ªß</h1>
                <div class="user-info">
                    <div id="user-profile" class="user-profile" style="display: none;">
                        <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                        <span id="user-name"></span>
                        <button id="logout-btn" class="logout-btn" title="ƒêƒÉng xu·∫•t">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <button id="login-btn" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                    </button>
                    <span id="current-date"></span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <div class="container">
                <button class="tab-btn active" data-tab="home">
                    <i class="fas fa-home"></i> Trang ch·ªß
                </button>
                <button class="tab-btn" data-tab="log">
                    <i class="fas fa-plus-circle"></i> Ghi nh·∫≠n
                </button>
                <button class="tab-btn" data-tab="history">
                    <i class="fas fa-history"></i> L·ªãch s·ª≠
                </button>
                <button class="tab-btn" data-tab="stats">
                    <i class="fas fa-chart-bar"></i> Th·ªëng k√™
                </button>
                <button class="tab-btn" data-tab="settings">
                    <i class="fas fa-cog"></i> C√†i ƒë·∫∑t
                </button>
                <button class="tab-btn" data-tab="ai-advice">
                    <i class="fas fa-robot"></i> T∆∞ v·∫•n AI
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                
                <!-- Home Tab -->
                <div id="home-tab" class="tab-content active">
                    <div class="dashboard">
                        <div class="stats-summary">
                            <div class="stat-card">
                                <i class="fas fa-bed"></i>
                                <div class="stat-info">
                                    <h3>ƒê√™m qua</h3>
                                    <p id="last-night-sleep">--</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-clock"></i>
                                <div class="stat-info">
                                    <h3>Trung b√¨nh 7 ng√†y</h3>
                                    <p id="weekly-average">--</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-target"></i>
                                <div class="stat-info">
                                    <h3>M·ª•c ti√™u</h3>
                                    <p id="sleep-goal">8h 00m</p>
                                </div>
                            </div>
                        </div>

                        <div class="quick-actions">
                            <h2>H√†nh ƒë·ªông nhanh</h2>
                            <div class="action-buttons">
                                <button class="action-btn" onclick="quickSleep()">
                                    <i class="fas fa-moon"></i>
                                    ƒêi ng·ªß ngay
                                </button>
                                <button class="action-btn" onclick="quickWakeup()">
                                    <i class="fas fa-sun"></i>
                                    V·ª´a th·ª©c d·∫≠y
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Log Sleep Tab -->
                <div id="log-tab" class="tab-content">
                    <div class="sleep-log-form">
                        <h2>Ghi nh·∫≠n gi·∫•c ng·ªß</h2>
                        <form id="sleep-form">
                            <div class="form-group">
                                <label for="sleep-date">Ng√†y:</label>
                                <input type="date" id="sleep-date" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bedtime">Gi·ªù ƒëi ng·ªß:</label>
                                    <input type="time" id="bedtime" required>
                                </div>
                                <div class="form-group">
                                    <label for="wakeup-time">Gi·ªù th·ª©c d·∫≠y:</label>
                                    <input type="time" id="wakeup-time" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="sleep-quality">Ch·∫•t l∆∞·ª£ng gi·∫•c ng·ªß:</label>
                                <div class="quality-rating">
                                    <button type="button" class="quality-btn" data-rating="1">üò¥</button>
                                    <button type="button" class="quality-btn" data-rating="2">üòê</button>
                                    <button type="button" class="quality-btn" data-rating="3">üòä</button>
                                    <button type="button" class="quality-btn" data-rating="4">üòç</button>
                                    <button type="button" class="quality-btn" data-rating="5">ü•∞</button>
                                </div>
                                <input type="hidden" id="sleep-quality" value="3">
                            </div>

                            <div class="form-group">
                                <label for="sleep-notes">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                                <textarea id="sleep-notes" rows="3" placeholder="V√≠ d·ª•: cƒÉng th·∫≥ng, u·ªëng c√† ph√™ mu·ªôn, t·∫≠p th·ªÉ d·ª•c..."></textarea>
                            </div>

                            <button type="submit" class="submit-btn">
                                <i class="fas fa-save"></i> L∆∞u b·∫£n ghi
                            </button>
                        </form>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history-tab" class="tab-content">
                    <div class="sleep-history">
                        <h2>L·ªãch s·ª≠ gi·∫•c ng·ªß</h2>
                        <div class="history-controls">
                            <select id="history-filter">
                                <option value="week">7 ng√†y qua</option>
                                <option value="month">30 ng√†y qua</option>
                                <option value="all">T·∫•t c·∫£</option>
                            </select>
                        </div>
                        <div id="sleep-history-list" class="history-list">
                            <!-- Danh s√°ch l·ªãch s·ª≠ s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="stats-tab" class="tab-content">
                    <div class="statistics">
                        <h2>Th·ªëng k√™ gi·∫•c ng·ªß</h2>
                        <div class="stats-overview">
                            <div class="stat-item">
                                <h3>T·ªïng s·ªë ƒë√™m ƒë√£ ghi nh·∫≠n</h3>
                                <span id="total-nights">0</span>
                            </div>
                            <div class="stat-item">
                                <h3>Th·ªùi gian ng·ªß trung b√¨nh</h3>
                                <span id="average-sleep">0h 0m</span>
                            </div>
                            <div class="stat-item">
                                <h3>Ch·∫•t l∆∞·ª£ng gi·∫•c ng·ªß trung b√¨nh</h3>
                                <span id="average-quality">0</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sleep-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <div class="settings">
                        <h2>C√†i ƒë·∫∑t</h2>
                        <div class="settings-form">
                            <div class="form-group">
                                <label for="sleep-goal-setting">M·ª•c ti√™u gi·∫•c ng·ªß (gi·ªù):</label>
                                <input type="number" id="sleep-goal-setting" min="4" max="12" step="0.5" value="8">
                            </div>
                            <div class="form-group">
                                <label for="bedtime-reminder">Nh·∫Øc nh·ªü ƒëi ng·ªß:</label>
                                <input type="time" id="bedtime-reminder" value="22:00">
                            </div>
                            <div class="form-group">
                                <label for="enable-notifications">
                                    <input type="checkbox" id="enable-notifications">
                                    B·∫≠t th√¥ng b√°o
                                </label>
                            </div>
                            <button class="submit-btn" onclick="saveSettings()">
                                <i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t
                            </button>
                            <button class="danger-btn" onclick="clearAllData()">
                                <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£ d·ªØ li·ªáu
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Advice Tab -->
                <div id="ai-advice-tab" class="tab-content">
                    <div class="ai-advice">
                        <div class="ai-analysis-section">
                            <h2>Ph√¢n t√≠ch Gi·∫•c ng·ªß Th√¥ng minh</h2>
                            <p>H·ªá th·ªëng s·∫Ω ph√¢n t√≠ch d·ªØ li·ªáu ng·ªß c·ªßa b·∫°n v√† ƒë∆∞a ra l·ªùi khuy√™n c√° nh√¢n h√≥a</p>
                            
                            <div class="analysis-summary">
                                <div class="summary-card">
                                    <h3>T√≥m t·∫Øt tu·∫ßn qua</h3>
                                    <div id="weekly-sleep-summary">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                                </div>
                                <div class="summary-card">
                                    <h3>V·∫•n ƒë·ªÅ ch√≠nh</h3>
                                    <div id="main-issues">Ch∆∞a ph√¢n t√≠ch</div>
                                </div>
                            </div>
                            
                            <div class="ai-recommendations">
                                <div class="recommendation-cards">
                                    <div class="card-header">
                                        <h3>K·∫ø ho·∫°ch ng·ªß h√¥m nay</h3>
                                    </div>
                                    <div class="card-content">
                                        <div id="today-sleep-plan">Ch∆∞a c√≥ k·∫ø ho·∫°ch</div>
                                    </div>
                                </div>
                                
                                <div class="recommendation-cards">
                                    <div class="card-header">
                                        <h3>Th·ªùi gian ng·ªß t·ªëi ∆∞u</h3>
                                    </div>
                                    <div class="card-content">
                                        <div id="suggested-bedtime">Ch∆∞a c√≥ g·ª£i √Ω</div>
                                    </div>
                                </div>
                                
                                <div class="recommendation-cards">
                                    <div class="card-header">
                                        <h3>L·ªùi khuy√™n s·ª©c kh·ªèe</h3>
                                    </div>
                                    <div class="card-content">
                                        <div id="health-advice">Ch∆∞a c√≥ l·ªùi khuy√™n</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ai-actions">
                                <button id="analyze-sleep-btn" class="btn btn-primary">
                                    <i class="fas fa-magic"></i> Ph√¢n t√≠ch gi·∫•c ng·ªß
                                </button>
                            </div>
                            
                            <div class="ai-status">
                                <div id="ai-loading" class="loading-indicator" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...
                                </div>
                                <div id="ai-error" class="error-message" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</h2>
                <button class="modal-close" id="close-login-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="auth-options">
                    <button id="google-login" class="auth-btn google-btn">
                        <i class="fab fa-google"></i>
                        ƒêƒÉng nh·∫≠p v·ªõi Google
                    </button>
                    
                    <button id="google-login-redirect" class="auth-btn google-btn redirect-btn" style="margin-top: 10px; background: #ff9800;">
                        <i class="fas fa-external-link-alt"></i>
                        ƒêƒÉng nh·∫≠p Google (Ch·∫ø ƒë·ªô chuy·ªÉn h∆∞·ªõng)
                    </button>
                    
                    <button id="check-popup-status" class="auth-btn info-btn" style="margin-top: 10px; background: #2196F3;">
                        <i class="fas fa-info-circle"></i>
                        Ki·ªÉm tra tr·∫°ng th√°i Popup
                    </button>
                    
                    <button id="check-firebase-status" class="auth-btn info-btn" style="margin-top: 10px; background: #4CAF50;">
                        <i class="fas fa-database"></i>
                        Ki·ªÉm tra tr·∫°ng th√°i Firebase
                    </button>
                    
                    <div class="divider">
                        <span>ho·∫∑c</span>
                    </div>
                    
                    <form id="email-auth-form">
                        <div class="auth-tabs">
                            <button type="button" id="login-tab" class="auth-tab active">ƒêƒÉng nh·∫≠p</button>
                            <button type="button" id="register-tab" class="auth-tab">ƒêƒÉng k√Ω</button>
                        </div>
                        
                        <div class="form-group">
                            <label for="auth-email">Email:</label>
                            <input type="email" id="auth-email" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email">
                        </div>
                        
                        <div class="form-group">
                            <label for="auth-password">M·∫≠t kh·∫©u:</label>
                            <input type="password" id="auth-password" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                        </div>
                        
                        <div id="register-fields" style="display: none;">
                            <div class="form-group">
                                <label for="auth-confirm-password">X√°c nh·∫≠n m·∫≠t kh·∫©u:</label>
                                <input type="password" id="auth-confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
                            </div>
                            <div class="form-group">
                                <label for="auth-display-name">T√™n hi·ªÉn th·ªã:</label>
                                <input type="text" id="auth-display-name" placeholder="T√™n c·ªßa b·∫°n">
                            </div>
                        </div>
                        
                        <button type="submit" id="email-auth-submit" class="auth-btn email-btn">
                            <i class="fas fa-envelope"></i>
                            <span id="auth-submit-text">ƒêƒÉng nh·∫≠p</span>
                        </button>
                    </form>
                </div>
                
                <div id="auth-loading" class="auth-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>ƒêang x·ª≠ l√Ω...</p>
                </div>
            </div>
        </div>
    </div>



    <!-- Load scripts in correct order -->
    <script src="config.js"></script>
    <script src="api-proxy-config.js"></script>
    <script>
        // Initialize Firebase immediately after config loads
        if (typeof CONFIG !== 'undefined') {
            console.log('CONFIG loaded successfully:', CONFIG);
            
            const firebaseConfig = CONFIG.FIREBASE_CONFIG;
            console.log('Firebase config:', firebaseConfig);
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // Make auth and db globally available
            window.auth = auth;
            window.db = db;
            
            // Configure Firestore settings with modern cache configuration
            db.settings({
                cache: {
                    sizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                }
            });
            
            // Enable offline persistence with modern settings
            db.enablePersistence({
                synchronizeTabs: true
            }).catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.warn('The current browser does not support offline persistence');
                }
            });
            
            console.log('Firebase initialized successfully');
            
            // Now load the main script
            const script = document.createElement('script');
            script.src = 'script.js';
            script.onload = function() {
                console.log('script.js loaded successfully');
                
                // Load AI advice after main script
                const aiScript = document.createElement('script');
                aiScript.src = 'ai-advice.js';
                aiScript.onload = function() {
                    console.log('ai-advice.js loaded successfully');
                };
                document.head.appendChild(aiScript);
            };
            document.head.appendChild(script);
            
        } else {
            console.error('CONFIG not loaded! Check if config.js exists and is accessible.');
        }
    </script>
</body>
</html>

</body>
</html>